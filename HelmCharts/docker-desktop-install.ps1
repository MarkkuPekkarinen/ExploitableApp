$uuid=$(-join ((97..122) | Get-Random -Count 6 | % {[char]$_}))
$domain="$uuid.docker.local"

####################################################
#Add Charts
####################################################

#Create exploitable namespace
kubectl create namespace exploitable

#Guacamole
helm install $(echo "guac-$uuid")  ./charts/guacamole/ --set hostName=$(echo "$domain") --namespace exploitable

#Exploitable App
helm install $(echo "db-$uuid") ./charts/db/ --set fullnameOverride=$(echo "db-$uuid") --namespace exploitable
helm install $(echo "redis-$uuid") ./charts/redis/ --set fullnameOverride=$(echo "redis-$uuid") --namespace exploitable
helm install $(echo "exploitableapp-ws-$uuid") ./charts/exploitableappwebservice/ `
  --set fullnameOverride=$(echo "svc-$uuid") `
  --set dbServer=$(echo "db-$uuid") `
  --set redisServer=$(echo "redis-$uuid") `
  --set webServer=$(echo "web-$uuid") `
  --set webServiceServer=$(echo "svc-$uuid") `
  --set postgresHostName=$(echo "guac-$uuid-postgres") `
  --namespace exploitable
helm install $(echo "exploitableapp-$uuid") ./charts/exploitableapp/ `
  --set fullnameOverride=$(echo "web-$uuid") `
  --set dbServer=$(echo "db-$uuid") `
  --set redisServer=$(echo "redis-$uuid") `
  --set webServer=$(echo "web-$uuid") `
  --set webServiceServer=$(echo "svc-$uuid") `
  --set flag=$(echo "flag-$uuid") `
  --namespace exploitable

while ($(kubectl get pods --namespace exploitable | Select-String -Quiet '0/1') -eq $True) { echo 'Waiting on Pods(10s)'; sleep 10; }

$POD_NAME_GUAC=$(kubectl get pods --namespace exploitable -l "app=guac-$uuid-guacamole,release=guac-$uuid" -o jsonpath="{.items[0].metadata.name}")  
start-process -filepath	"kubectl" -argumentlist ("port-forward", "$POD_NAME_GUAC", "17498:8080", "--namespace", "exploitable") -WindowStyle Hidden

$POD_NAME_EXP=$(kubectl get pods --namespace exploitable -l "app=exploitableapp,release=exploitableapp-$uuid" -o jsonpath="{.items[0].metadata.name}")  
start-process -filepath	"kubectl" -argumentlist ("port-forward", "$POD_NAME_EXP", "17499:8080", "--namespace", "exploitable") -WindowStyle Hidden

echo "################################################################################################################"
echo "################################################################################################################"
echo ""
echo "You can access the backend site here http://localhost:17498/guacamole/"
echo "You can access the main site here http://localhost:17499/"
echo ""
echo "################################################################################################################"
echo "################################################################################################################"

####################################################
#Wait on Input
####################################################
echo ""
echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
echo ""
echo "Press 'Enter' to tear it all down and exit"
echo ""
echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
echo "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
read-host

####################################################
#Stop Jobs, Remove Charts & Namespace
####################################################
helm list --namespace exploitable --output json | ConvertFrom-Json | ForEach-Object { helm uninstall $_.name --namespace exploitable }
kubectl delete namespace exploitable
Stop-Process -Name kubectl